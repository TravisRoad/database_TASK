# 数据库系统实验报告

[TOC]

## 实验环境

* Windows 10 Pro 2004、macOS 11.0
* MySQL Workbench、DataGrip 2020.3

## 数据库连接

### 实验目的

* 掌握DAS连接GaussDB(for MySQL)数据库实例。

### 实验内容

* 通过华为云数据管理服务 (Data Admin Service，简称DAS) ，通过预先分配好的 IAM 子账号，来连接华为云 GaussDB(for MySQL) 数据库实例。
* 通过 DataGrip 公网连接 GaussDB(for MySQL) 数据库实例。
* 向服务器导入本地数据表。
* 修正数据类型。

### 实验步骤

1. 登录数据库
2. 导入数据表
3. 修正数据类型

* 实验过程略，仅展示结果。

<img src="实验报告.assets/image-20201201161604512.png" alt="image-20201201161604512" style="zoom:50%;" />

<img src="实验报告.assets/image-20201201161723417.png" alt="image-20201201161723417" style="zoom:50%;" />

<img src="实验报告.assets/image-20201201162411841.png" alt="image-20201201162411841" style="zoom:50%;" />

## 数据查询与修改

### 实验目的

* 对前两个实验建立的LTE数据库关系表和视图进行各种类型的查询操作和修改操作，加深对SQL语言中DML的了解，掌握相关查询语句和数据修改语句的使用方法。

### 实验内容

1. 单表简单查询，包括复合选择条件、结果排序、结果去重、结果重命名查询；
2. 多表查询，包括等值连接、自然连接、元组变量查询；
3. 统计查询，包括带有分组、聚集函数的查询；
4. 嵌套查询，包括带有 in/some/all、exists、unique 的嵌套查询，from 中子查询；
5. with 临时视图查询；
6. 键/函数依赖分析；
7. 表的插入、删除、更新

### 实验步骤

#### 单表查询

##### 查询1

从小区/基站信息表tbCell表中，找出“sanxia”市满足下列条件的所有小区cell：

（1）所属基站的经纬度范围分别位于[？,？]、[？,？？]，并且

（2）PCI值在？至？之间，并且

（3）设备厂家VENDOR不为空

列出这些小区的小区标识（Sector_ID）、小区名、所属基站的基站ID和基站名、基站经纬度、小区PCI、小区天线的方位角(azimuth)和高度(height)；

要求：对查询结果，按照经度范围从大到小、纬度范围从大到小、频点(RARFCN)从高到低排序，并且将PCI重新命名为Physical Cell Identity。

说明：？代表由学生自己选择输入条件

----

```mysql
SELECT ENODEBID, ENODEB_NAME, LONGITUDE, LATITUDE, PCI as "Physical Cell Identity", AZIMUTH, HEIGHT
FROM user58db.`1tbcell`
WHERE LONGITUDE BETWEEN 100 AND 120
  AND CITY = "sanxia"
  AND LATITUDE BETWEEN 20 AND 40
  AND PCI BETWEEN 0 AND 200
  AND VENDOR is not null
ORDER BY LONGITUDE DESC, LATITUDE DESC, EARFCN DESC;
```

![image-20201201170440588](实验报告.assets/image-20201201170440588.png)



##### 查询2：

从小区/基站信息表tbCell表中，找出“sanxia”市满足下列条件的所有基站ENodeB：

（1）所属基站的经纬度范围分别位于[？-？]、[？,？？]，

（2）属于该基站的小区中，至少有一个小区的PCI值在？至？之间

列出这些基站的基站ID和基站名、基站经纬度、基站类型(Style)、设备生产厂家(Vendor)；要求：对查询结果，按照基站位置从北到南、从东到西排序，并且对查询结果使用distinct去重。

比较对查询结果去重和不去重，在查询时间和查询结果上的差异。

----

* 不去重：

```mysql
SELECT ENODEBID, ENODEB_NAME, LONGITUDE, LATITUDE, STYLE, VENDOR
FROM user58db.`1tbcell`
WHERE LONGITUDE BETWEEN 100 AND 120
  AND CITY = "sanxia"
ORDER BY LONGITUDE DESC, LATITUDE DESC;
```

![image-20201201170648831](实验报告.assets/image-20201201170648831.png)

* 去重：

```mysql
SELECT distinct ENODEBID, ENODEB_NAME, LONGITUDE, LATITUDE, STYLE, VENDOR
FROM user58db.`1tbcell`
WHERE LONGITUDE BETWEEN 100 AND 120
  AND CITY = "sanxia"
ORDER BY LONGITUDE DESC, LATITUDE DESC;
```

![image-20201201170744459](实验报告.assets/image-20201201170744459.png)

* 进行去重查询，花费时间略长于不去重。



#### String 操作

##### 查询3：

从小区/基站信息表tbCell表中，找出满足下列条件的小区：

（1）小区名开头部分包含“A池”或“高铁”，或者基站名中包含“医院”或“实验高中”，并且

（2） 不是所属基站的第1小区，即小区名结尾部分不是“-1”

----

```mysql
SELECT SECTOR_NAME
FROM user58db.`1tbcell`
WHERE (SECTOR_NAME LIKE "A池%"
    OR SECTOR_NAME LIKE "高铁%"
    OR SECTOR_NAME LIKE "%医院%"
    OR SECTOR_NAME LIKE "%实验高中%")
  AND NOT SECTOR_NAME LIKE "%-1";
```

![image-20201201170902351](实验报告.assets/image-20201201170902351.png)



##### 查询4：

从小区/基站信息表tbCell表中，找出满足下列条件的小区：

（1）小区标识由5个字符组成，并且

（2）小区所属基站的名字/标识至少包括8个字符，即名字字符串的长度不小于8。

----

```mysql
SELECT SECTOR_NAME
FROM user58db.`1tbcell`
WHERE SECTOR_NAME LIKE "_____-%-%"
  AND ENODEB_NAME LIKE "____%____";
```

![image-20201201171139246](实验报告.assets/image-20201201171139246.png)

 

#### 集合操作

##### 查询5：

使用集合并操作union、union all，从小区KPI指标表tbCellKPI查询满足下列条件的小区

(1)小区RRC建立成功率qf (%)大于95%，或者

(2)E-RAB建立成功率2 (%)大于99%

对比union all、union操作在查询结果、执行时间上的差异。

----

```sql
(SELECT SECTOR, SECTOR_NAME
 FROM user58db.`12tbcellkpi`
 WHERE QF > 0.95)
UNION ALL
(SELECT SECTOR, SECTOR_NAME
 FROM user58db.`12tbcellkpi`
 WHERE ERABf > 0.99)
```

 

##### 查询6：

结合教材3.4.1节元组变量样例，使用集合操作except、except all，从小区/基站信息表tbCell表中，查询位于最北端（具有最大纬度）的基站。

对比使用except、except all、聚集函数max，完成此查询在执行时间、查询结果上的异同。

----

```sql
SELECT ENODEBID, ENODEB_NAME
FROM user58db.`1tbcell`
WHERE LATITUDE in (
    SELECT MAX(LATITUDE) as LATITUDE
    FROM user58db.`1tbcell`
);
```



#### 多表查询

##### 查询7：

选取两张数据量比较大的表T1和T2，如tbMROData、tbCellTraffic、tbC2I、tbHandover，执行如下无连接条件的笛卡尔积操作，观察数据库系统的反应和查询结果：

  Select * from T1, T2

----

```sql
use user58db;
SELECT *
FROM `9tbmrodata`,
     `6tbatudata`;
```

###### 查询8：

使用多表连接操作（3.3.3 join/natual join，4.1.1 join），从小区/基站信息表tbCell表、小区一阶邻区关系表tbAdjCell、小区二阶（同频）邻区关系表tbSecAdjCell中，查询有相同的一阶邻小区和二阶邻小区的主小区，列出这些主小区的小区标识、小区名称、小区频点，以及该小区的一阶邻小区和二阶邻小区的小区标识及其频点。

----

```sql
select *
from user58db.`2tbadjcell` as a
         inner join user58db.`3tbsecadjcel` as b
                    on a.S_SECTOR_ID = b.S_SECTOR_ID and a.N_SECTOR_ID = b.N_SECTOR_ID;
```

 

##### 查询9：

使用多表连接操作，从小区/基站信息表tbCell表、路测ATU C2I干扰矩阵表tbATUC2I、路测ATU切换统计矩阵表tbATUHandover中，查询小区标识ID为“238397-1”的主小区的同站干扰小区的小区和切换目标小区，列出主小区名称和ID、同站干扰小区的ID、切换目标小区的ID。

----

```sql
SELECT *
FROM (
         select A.SECTOR_ID,
                C.SECTOR_NAME,
                A.NCELL_ID,
                B.NSECTOR_ID
         FROM user58db.`7tbatuc2i` AS A
                  INNER JOIN user58db.`8tbatuhandover` AS B
                  INNER JOIN user58db.`1tbcell` AS C
                             ON A.SECTOR_ID = B.NSECTOR_ID AND A.SECTOR_ID = C.SECTOR_ID
         WHERE A.SECTOR_ID = "238397-1"
           and COSITE = 1
     ) AS TMP;
```

 

##### 查询10：

利用MR测量报告干扰分析表tbC2I表，使用教材3.4.1节元组变量as/rename方式，查询所有比主小区ID为“124673-0”，邻小区ID为“259772-0”的小区间C2I干扰均值高的主小区、邻小区，列出这些主邻小区的名称、ID和C2I干扰值，结果按照C2I干扰均值的降序排列。

----

```sql
SELECT B.SCELL, C.SECTOR_NAME AS SS_NAME, B.NCELL, D.SECTOR_NAME AS NS_NAME
FROM user58db.`10tbc2i` AS A,
     user58db.`10tbc2i` AS B,
     user58db.`1tbcell` AS C,
     user58db.`1tbcell` AS D
WHERE A.SCELL = "124673-0"
  AND A.NCELL = "259772-0"
  AND A.C2I_Mean < B.C2I_Mean
  AND C.SECTOR_ID = B.SCELL
  AND D.SECTOR_ID = B.NCELL
ORDER BY B.C2I_Mean DESC;
```

 

#### 聚集函数

##### 查询11：

从小区小时级话务量表tbCellTraffic、从小区/基站信息表tbCell表，查询2020年5月期间，每天忙时时段（包括早9点-11点2个小时、晚19点-21点，共4个小时）的位于经度范围[？,?]、纬度范围[?,?]内的

（1）全部小区的最大月忙时话务量、最小月忙时话务量、平均月忙时话务量;

（2）具有最大月忙时话务量的小区，列出该小区ID、名称、经纬度位置，以及月忙时话务量。

月忙时话务量=月内各天的忙时话务量累加

----

```sql
-- 最大值得相关信息
with t as (SELECT sum(A.Traffic) as s, A.Sector_ID, B.SECTOR_NAME, B.LONGITUDE, B.LATITUDE
           FROM user58db.`tbcell_traffic` AS A
                    INNER JOIN user58db.`1tbcell` AS B ON A.Sector_ID = B.SECTOR_ID
           WHERE (
               A.Hour BETWEEN 9 AND 11 OR A.Hour BETWEEN 19 AND 21
               )
             AND B.LATITUDE BETWEEN -90
               AND 90
             AND B.LONGITUDE BETWEEN 0
               AND 120
             AND str_to_date(A.Date, "%m/%d/%Y %H:%i:%s") BETWEEN str_to_date("05/01/2020", "%m/%d/%Y %H:%i:%s")
               AND str_to_date("5/31/2020", "%m/%d/%Y %H:%i:%s")
           GROUP BY A.SECTOR_ID)
select max(s) as MAX, t.Sector_ID, t.SECTOR_NAME, t.LATITUDE, t.LONGITUDE
from t
WHERE s = (SELECT MAX(t.s) from t);

-- 最大最小平均
with t as (SELECT sum(A.Traffic) as s, A.Sector_ID, B.SECTOR_NAME, B.LONGITUDE, B.LATITUDE
           FROM user58db.`tbcell_traffic` AS A
                    INNER JOIN user58db.`1tbcell` AS B ON A.Sector_ID = B.SECTOR_ID
           WHERE (
               A.Hour BETWEEN 9 AND 11 OR A.Hour BETWEEN 19 AND 21
               )
             AND B.LATITUDE BETWEEN -90
               AND 90
             AND B.LONGITUDE BETWEEN 0
               AND 120
             AND str_to_date(A.Date, "%m/%d/%Y %H:%i:%s") BETWEEN str_to_date("05/01/2020", "%m/%d/%Y %H:%i:%s")
               AND str_to_date("5/31/2020", "%m/%d/%Y %H:%i:%s")
           GROUP BY A.SECTOR_ID)
SELECT MAX(t.s), MIN(t.s), AVG(t.s)
from t;
```

 

##### 查询12：

根据优化小区/保护带小区表tbOptCell和小区一阶邻区关系表tbAdjCell，查询一阶邻区数大于10的优化小区，给出这些优化小区的标识、名称，以及邻区数量，并将查询结果按照邻区数目降序排列。

----

```sql
SELECT A.SECTOR_ID, C.SECTOR_NAME, COUNT(B.N_SECTOR_ID) AS CNT
FROM user58db.`4tboptcell` AS A
         JOIN user58db.`2tbadjcell` AS B
         JOIN user58db.`1tbcell` AS C
              ON A.SECTOR_ID = B.S_SECTOR_ID AND A.SECTOR_ID = C.SECTOR_ID
WHERE A.CELL_TYPE = "优化区"
GROUP BY A.SECTOR_ID
HAVING COUNT(B.N_SECTOR_ID) > 10
ORDER BY CNT DESC;
```





##### 查询13：

从小区话务量表tbCellTraffic、小区/基站信息表tbCell表中，查询所有包含38400频点的基站的年平均小时级话务量avgTraffic，给出年平均话务量超出avgTraffic的基站ID名称、基站年平均话务量，结果按照年平均话务量降序排列。

注：1个基站ENodeB有1~3个38400频点小区。

----

```sql
use user58db;
select avg(a.Traffic) as average, a.Sector_ID
from tbcell_traffic as a
         inner join `1tbcell` as b on a.Sector_ID = b.SECTOR_ID
group by year(str_to_date(a.Date, "%m/%d/%Y %H:%i:%s")), a.Sector_ID
having average > (select avg(a.Traffic)
                  from tbcell_traffic as a
                           inner join `1tbcell` as b on a.Sector_ID = b.SECTOR_ID
                  where b.EARFCN = 38400)
order by average DESC;
```

 

#### 嵌套查询

##### 查询14：

从小区/基站信息表tbCell、优化小区/保护带小区tbOptCell和小区PCI优化调整结果表tbPCIAssignment中，使用set membership运算符in，查询小区类型为“优化区”的小区、PCI调整前后没有发生变化的小区，列出这些优化小区的ID和名称、调整前后的PCI。

对比使用多表连接、非嵌套的查询在执行时间、查询结果上的异同。

----

```sql
use user58db;
select `1tbcell`.SECTOR_ID, `1tbcell`.SECTOR_NAME, `1tbcell`.PCI, `5tbpciassignment`.PCI
from `1tbcell`,
     `4tboptcell`,
     `5tbpciassignment`
where `1tbcell`.SECTOR_ID = `5tbpciassignment`.SECTOR_ID
  and `1tbcell`.PCI = `5tbpciassignment`.PCI;
```

 

##### 查询15-1：

从小区/基站信息表tbCell，使用Set Comparison 运算符some，查询满足下列条件的小区：该小区的天线高度height高于位于经度在[?,?]、纬度在[?,?]区域内的部分（至少一个）小区的天线高度，列出这些小区的名称、标识和天线高度。

----

```sql
use user58db;
select SECTOR_ID, SECTOR_NAME, HEIGHT
from `1tbcell`
where HEIGHT > some (select HEIGHT
                     from `1tbcell`
                     where 111 <= LONGITUDE <= 112
                       and 33.2 <= LATITUDE <= 33.6)
```
 

##### 查询15-2：

从路测ATU数据表tbATUdata，使用Set Comparison 运算符some，查询满足下列条件的小区：在路测数据中作为主小区/服务小区CELLID，其参考信号接收功率RSRP，大于部分（基站标识ENodeBID=253903的小区作为主小区/服务小区时的参考信号接收功率RSRP。列出这些小区的ID、名称、在测量报告中作为主服务小区的RSRP。

----

```sql
use user58db;
select CellID, RSRP
from `6tbatudata`
where RSRP > some (select RSRP
                   from `6tbatudata`
                   where CellID in (select SECTOR_ID
                                    from `5tbpciassignment`
                                    where ENODEB_ID = 253903));
```

##### 查询16-1：

从小区小时级话务量表tbCellTraffic中，使用Set Comparison 运算符>=all，查询全年小时级话务量总和满足下列条件的小区：该小区的全年话务量总和大于等于其它小区的全年话务量总和，即该小区的全年话务量总和最高。

----

```sql
use user58db;
select Sector_ID
from tbcell_traffic
group by Sector_ID
having sum(Traffic) >= all (select sum(Traffic)
                            from tbcell_traffic
                            group by Sector_ID)
```

 

##### 查询16-2：

切换统计表tbHandOver，使用Set Comparison 运算符all，查询作为源小区SCELL与周边目标/邻小区NCELL发生切换次数(HOATT)最多的小区。列出这些源小区的ID、目标/邻小区ID、发生的切换次数。

----

```sql
use user58db;
select SCELL, NCELL, HOATT
from `11tbhandover`
group by SCELL
having max(HOATT);

/*
where HOATT >= all (select HOATT
                    from `11tbhandover`);*/
```
 

##### 查询17-1：

从切换统计表tbHandOver表，使用Test for Empty Relations运算符“not exists”，查询作为源小区SCELL，其切换邻小区NCELL包含了{15290-128, 259595-1, 124711-0, 47444-1}中的全部四个小区。

----

```sql
# mysql doesn't have not exists clause!
/*use user58db;
select SCELL, NCELL
from `11tbhandover`
where NCELL not exists (select NCELL
                    from `11tbhandover`
                    where NCELL in ('15290-128', '259595-1', '124711-0', '47444-1'))
*/

```

##### 查询17-2：

从一阶邻区表tbAdjCell、二阶邻区表tbSecAdjCell中，使用Test for Empty Relations 运算符“not exists”，查询满足下列条件的源小区S_SECTOR_ID：该小区的一阶邻小区包含其全部二阶邻小区，或者该小区的二阶邻小区包含其全部一阶邻小区。

----

 ```sql
# mysql doesn't have not exists clause!

/*use user58db;
select adj.S_SECTOR_ID
from `2tbadjcell` as adj,
     `3tbsecadjcel` as secadj
where not exists(select )*/
```



###### 查询18：

从小区/基站信息表tbCell、一阶邻区表tbAdjCell中，使用Test for Absence of Duplicate Tuples运算符not unique，查询满足下列条件的源小区：ENodeBID=15114的基站下有多个小区，该源小区至少是基站15114下2个小区的邻小区。

----

 ```sql
# mysql doesn't have not unique clause!

use user58db;
select all SECTOR_ID
from `1tbcell`,
     `2tbadjcell`
where S_SECTOR_ID in (
    select SECTOR_ID
    from `1tbcell`
    where ENODEBID = 15114
)
  and N_SECTOR_ID = SECTOR_ID
group by SECTOR_ID
having count(SECTOR_ID) >= 2;



```

##### 查询19：

从小区KPI性能表tbCellKPI中，使用Subqueries in the From Clause方法，查询满足下列条件的小区：小区在2020/07/17-2020/0719这三天的平均RRC建立成功率大于0.992，给出这些小区的ID和其三天平均连接成功率。

----

```sql
use user58db;
select SECTOR_ID, aQF
from (select SECTOR_NAME, avg(QF) as aQF
      from `12tbcellkpi`
      group by SECTOR_NAME) as SNaQ,
     `1tbcell`
where aQF > 0.992
  and `1tbcell`.SECTOR_NAME = SNaQ.SECTOR_NAME;
```


#### with临时视图查询

##### 查询20：

用with临时视图方式，实现查询19中查询要求。
----

```sql
use user58db;
with avgQF(aQF, aNAME) as (select avg(QF), SECTOR_NAME
                           from `12tbcellkpi`
                           group by SECTOR_NAME)
select SECTOR_ID, avgQF.aQF
from `1tbcell`,
     avgQF
where avgQF.aQF > 0.992
  and `1tbcell`.SECTOR_NAME = avgQF.aNAME;
```

##### 查询21：

从小区/基站信息表tbCell、一阶邻区表tbAdjCell中，用with临时视图方式，查询一阶邻小区最多的主小区，给出这些主小区的ID、邻小区数目。

----

```sql
use user58db;
with cSEC(SID, _count) as (select S_SECTOR_ID, count(N_SECTOR_ID)
                           from `2tbadjcell`
                           group by S_SECTOR_ID)
select SID, max(_count)
from cSEC,
     `1tbcell`;
```
 

#### 键/函数依赖分析

 

##### 查询22：

在MRO测量报告数据表tbMROData中，检查TimeStamp、ServingSector、InterferingSector是否组成超键。

----

```sql
use user58db;
select count(*)
from `9tbmrodata`
group by TimeStamp, ServingSector, InterferingSector;
```

##### 查询23：

在PCI优化分配表tbPCIAssignment中，利用SQL语句检查函数依赖ENODEB_ID$\rightarrow$PCI是否成立；如果不成立，利用SQL语句找出导致函数依赖不成立的元组。

----

```sql
use user58db;
select *
from `5tbpciassignment`
group by ENODEB_ID, PCI
having count(*) > 1
```
 

#### 关系表的插入/删除/更新


 

##### 查询24：

向小区一阶邻区关系表中插入一条邻区数据；

----

```sql
INSERT INTO user58db.`2tbadjcell`
VALUES (124673 - 0, 5691 - 128, 38400, 38400);
```

##### 查询25：

将小区124673-0的全部二阶邻小区，作为该小区的一阶邻小区，加入到一阶邻区表tbAdjCell中。

----

```sql
INSERT INTO user58db.`2tbadjcell`
SELECT B.S_SECTOR_ID, B.N_SECTOR_ID, NULL, NULL
FROM user58db.`3tbsecadjcel` AS B
WHERE B.S_SECTOR_ID = "124673-0";
```

##### 查询26：

在小区切换统计性能表tbHandover中，删除切换次数最少的那些切换数据。

----

```sql
# select *
# from user58db.`11tbhandover`
# order by HOATT asc;
#
# insert into user58db.`11tbhandover`
# values ("h","h","h",0,0,0);

delete
from user58db.`11tbhandover`
where HOATT = (select min(HOATT) from (select * from user58db.`11tbhandover`) as x);
```

##### 查询27：

用小区PCI优化调整结果表tbPCIAssignmeng给出的各个小区的优化调整后的PCI值，替换小区/基站消息表tbCell中对应小区的物理小区标识PCI。

----

```sql
update user58db.`1tbcell` AS a, user58db.`5tbpciassignment` as b
set a.PCI = b.PCI
where a.SECTOR_ID = b.SECTOR_ID;
```
 

##### 查询28：

针对路测ATU干扰矩阵表tbATUC2I，使用update/case语句做出如下修改：对主小区SECTOR_ID=238397-1，如果该小区与干扰小区N_SECTOR_ID为同站小区(cosite=1)且干扰强度排序rank不小于1，则干扰强度排序减1；如果主小区与干扰小区不同站，干扰强度排序加1。

----

```sql
update user58db.`7tbatuc2i`
set RATIO_ALL = case
                    when (`RANK` >= 1 and COSITE = 1) then RATIO_ALL - 1
                    when COSITE != 1 then RATIO_ALL + 1
                    else RATIO_ALL
    end
where SECTOR_ID = "238397-1";
```

























<style type="text/css">
    h1 { counter-reset: h2counter; }
    h2 { counter-reset: h3counter; }
    h3 { counter-reset: h4counter; }
    h4 { counter-reset: h5counter; }
    h5 { counter-reset: h6counter; }
    h6 { }
    h2:before {
      counter-increment: h2counter;
      content: counter(h2counter) ".\0000a0\0000a0";
    }
    h3:before {
      counter-increment: h3counter;
      content: counter(h2counter) "."
                counter(h3counter) ".\0000a0\0000a0";
    }
    h4:before {
      counter-increment: h4counter;
      content: counter(h2counter) "."
                counter(h3counter) "."
                counter(h4counter) ".\0000a0\0000a0";
    }
    h5:before {
      counter-increment: h5counter;
      content: counter(h2counter) "."
                counter(h3counter) "."
                counter(h4counter) "."
                counter(h5counter) ".\0000a0\0000a0";
    }
    h6:before {
      counter-increment: h6counter;
      content: counter(h2counter) "."
                counter(h3counter) "."
                counter(h4counter) "."
                counter(h5counter) "."
                counter(h6counter) ".\0000a0\0000a0";
    }
</style>